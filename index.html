<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Kylie's Bunny Clicker ü•ï</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Core Mobile Settings */
        :root {
            --primary-orange: #ff8c42;
            --primary-green: #8bc34a;
            --night-bg: #1a1a2e;
            /* Replaced solid color with day background image */
            --day-bg: url('image_0.jpg');
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            /* REMOVED background properties from body */
            
            color: #333;
            overflow: hidden; /* Prevent scroll */
            touch-action: manipulation; /* Improve touch response */
            -webkit-user-select: none; /* Prevent text selection */
            user-select: none;
            /* Transition on background-image for smooth day/night switch */
            transition: background-image 1s ease, color 1s ease;
            /* Added height/width constraints to help with mobile viewport */
            height: 100dvh; 
            width: 100vw;
            background-color: #e9f0ea; /* Fallback color */
        }

        /* Night Mode Transition */
        body.night-mode {
            /* REMOVED background-image from here */
            color: #e0e0e0;
            background-color: #1a1a2e; /* Fallback color */
        }
        
        /* NEW: Class for the farm background */
        .bg-farm {
            background-image: var(--day-bg);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 1s ease;
        }

        /* Night Mode for farm background */
        body.night-mode .bg-farm {
            background-image: url('image_1.jpg');
        }

        body.night-mode .panel-bg {
            /* Dark Sage for Night Mode Panels */
            background-color: #26352a !important; 
            border-color: #3b5241 !important;
        }

        /* The Giant Carrot */
        #giant-carrot {
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            z-index: 20;
        }
        #giant-carrot:active {
            transform: scale(0.9);
        }
        .carrot-squish {
            animation: squish 0.15s;
        }
        @keyframes squish {
            0% { transform: scale(1); }
            50% { transform: scale(1.1, 0.9); }
            100% { transform: scale(1); }
        }

        /* Floating Particles (+1) */
        .particle {
            position: absolute;
            pointer-events: none;
            font-weight: bold;
            font-size: 1.5rem;
            animation: floatUp 1s ease-out forwards;
            z-index: 50;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-80px) scale(1.5); }
        }

        /* Golden Bunny (Kylie Bunny) - Using GIF */
        #golden-bunny {
            position: absolute;
            width: 100px; /* Adjusted size for the gif (500px is too big for mobile) */
            height: auto;
            z-index: 40;
            display: none;
            transition: left 4s linear; 
        }

        /* Tab Panels */
        .tab-content {
            display: none;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 100px; /* Space for nav */
        }
        .tab-content.active {
            display: block;
        }

        /* Custom Scrollbar hide */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Button Press Effect */
        .btn-press:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        /* Carrot Storm Overlay */
        .storm-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, transparent 50%, rgba(255, 165, 0, 0.3) 100%);
            pointer-events: none;
            z-index: 10;
            display: none;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.3; }
            50% { opacity: 0.6; }
            100% { opacity: 0.3; }
        }
    </style>
</head>
<body class="h-[100dvh] w-screen flex flex-col relative">

    <!-- INTRO MODAL -->
    <div id="intro-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" style="display: none;">
        <div class="bg-[#e9f0ea] dark:bg-[#26352a] p-8 rounded-2xl max-w-md text-center shadow-2xl border-4 border-orange-400 mx-4 relative overflow-hidden">
            <!-- Confetti bg effect (simple) -->
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pink-500 via-orange-500 to-purple-500"></div>
            
            <h1 class="text-3xl font-black text-orange-500 mb-4 drop-shadow-sm">Happy 21st Birthday, Kylie! üéâ</h1>
            <p class="text-gray-700 dark:text-gray-300 mb-6 text-lg leading-relaxed">
                I made this little bunny world just for you. Tap carrots, build a bunny family, and have the best birthday ever!
            </p>
            <p class="text-gray-500 dark:text-gray-400 italic mb-8 text-sm">
                Love, Louie ‚ù§Ô∏è
            </p>
            <button onclick="game.closeIntro()" class="bg-orange-500 hover:bg-orange-600 text-white py-3 px-8 rounded-full font-bold text-xl shadow-lg transform transition hover:scale-105 btn-press">
                Let's Go! üê∞
            </button>
        </div>
    </div>

    <!-- Storm Effect -->
    <div id="storm-overlay" class="storm-overlay"></div>

    <!-- Golden Bunny (Changed to Image/GIF) -->
    <!-- Ensure bunny.gif is in the same folder as this file -->
    <img id="golden-bunny" src="bunny.gif" alt="Kylie Bunny" class="select-none cursor-pointer drop-shadow-lg filter hover:brightness-110">

    <!-- TOP: HUD -->
    <header class="flex-none p-4 pt-8 pb-2 bg-[#e9f0ea] dark:bg-[#354a3b] border-b border-[#d1e0d3] dark:border-[#4a6352] shadow-sm z-20 panel-bg transition-colors duration-500">
        <div class="flex justify-between items-center">
            <div>
                <div class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider">Kylie's Carrots</div>
                <div id="carrot-display" class="text-3xl font-black text-orange-600 font-mono">0</div>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider">Per Second</div>
                <div id="cps-display" class="text-xl font-bold text-green-600 font-mono">0.0</div>
            </div>
        </div>
        <!-- Prestige Bar (Hidden initially) -->
        <div id="prestige-status" class="hidden mt-2 text-xs text-purple-600 font-bold text-center">
            Bunny Spirit Active: <span id="spirit-bonus">0%</span> Boost
        </div>
    </header>

    <!-- MIDDLE: The Game Area (Tap Zone) -->
    <main id="click-zone" class="flex-grow flex flex-col items-center justify-center relative overflow-hidden bg-farm">
        
        <!-- Weather/Event Indicator -->
        <!-- CHANGED: z-10 -> z-50 so it appears in front of the carrot -->
        <div id="event-banner" class="absolute top-4 bg-pink-500 text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg transform -translate-y-24 transition-transform duration-300 z-50 text-center max-w-[90%]">
            EVENT ACTIVE!
        </div>

        <!-- The Giant Carrot -->
        <div id="giant-carrot" class="text-[180px] leading-none select-none relative z-10">
            ü•ï
        </div>
        
        <div class="mt-8 text-gray-400 text-sm font-medium animate-pulse"></div>

        <!-- Particle Container -->
        <div id="particle-container" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
    </main>

    <!-- BOTTOM: Controls & Shop -->
    <div class="flex-none bg-[#e9f0ea] dark:bg-[#26352a] h-[45dvh] rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] flex flex-col z-30 panel-bg transition-colors duration-500 -mt-10">
        
        <!-- Tabs Navigation -->
        <div class="flex border-b border-[#d1e0d3] dark:border-[#3b5241]">
            <button onclick="switchTab('bunnies')" class="flex-1 py-4 text-center font-bold text-gray-400 hover:text-orange-500 active-tab text-orange-500 border-b-2 border-orange-500 transition-colors" id="tab-btn-bunnies">
                <i class="fas fa-paw mb-1 block"></i> Bunnies
            </button>
            <button onclick="switchTab('burrows')" class="flex-1 py-4 text-center font-bold text-gray-400 hover:text-orange-500 transition-colors" id="tab-btn-burrows">
                <i class="fas fa-dungeon mb-1 block"></i> Burrows
            </button>
            <button onclick="switchTab('upgrades')" class="flex-1 py-4 text-center font-bold text-gray-400 hover:text-orange-500 transition-colors" id="tab-btn-upgrades">
                <i class="fas fa-bolt mb-1 block"></i> Upgrades
            </button>
            <button onclick="switchTab('settings')" class="flex-1 py-4 text-center font-bold text-gray-400 hover:text-orange-500 transition-colors" id="tab-btn-settings">
                <i class="fas fa-heart mb-1 block"></i> Options
            </button>
        </div>

        <!-- Tab Contents -->
        <div class="flex-grow relative overflow-hidden bg-[#f6f9f7] dark:bg-[#354a3b] transition-colors duration-500">
            
            <!-- BUNNIES TAB -->
            <div id="tab-bunnies" class="tab-content active p-4 space-y-3">
                <!-- Items injected by JS -->
            </div>

            <!-- BURROWS TAB -->
            <div id="tab-burrows" class="tab-content p-4 space-y-3">
                <!-- Items injected by JS -->
            </div>

            <!-- UPGRADES TAB -->
            <div id="tab-upgrades" class="tab-content p-4 space-y-3">
                <!-- Items injected by JS -->
            </div>

            <!-- SETTINGS/PRESTIGE TAB -->
            <div id="tab-settings" class="tab-content p-4 space-y-4">
                
                <div class="bg-purple-100 dark:bg-purple-900 p-6 rounded-xl text-center shadow-sm border border-purple-200 dark:border-purple-700">
                    <h3 class="text-lg font-bold text-purple-800 dark:text-purple-200 mb-2">Bunny Ascension</h3>
                    <p class="text-sm text-purple-600 dark:text-purple-300 mb-4">Reset progress to gain Bunny Spirit Points (BSP). Current BSP: <span id="current-bsp">0</span></p>
                    <p class="text-xs text-gray-500 mb-4">Resetting now gives: <span id="pending-bsp" class="font-bold text-purple-600">0</span> BSP</p>
                    <button onclick="game.prestige()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow-md btn-press">Ascend (Reset)</button>
                </div>

                <div class="space-y-2">
                    <button onclick="game.save()" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold shadow-sm btn-press">Force Save</button>
                    <button onclick="game.hardReset()" class="w-full bg-red-500 text-white py-3 rounded-lg font-bold shadow-sm btn-press">Wipe Save Data</button>
                </div>
                
                <div class="text-center text-xs text-gray-400 mt-4">
                    Happy 21st Birthday Kylie! ü•ï
                </div>
            </div>

        </div>
    </div>

    <script>
        /**
         * GAME CONFIGURATION & DATA
         */
        const CONFIG = {
            bunnies: [
                { id: 'baby', name: 'Baby Bunny', cost: 25, production: 0.2, icon: 'fa-baby', desc: 'Small and cute.' },
                { id: 'grower', name: 'Grower Bunny', cost: 150, production: 1, icon: 'fa-carrot', desc: 'Knows good veggies.' },
                { id: 'farmer', name: 'Farmer Bunny', cost: 500, production: 3, icon: 'fa-hat-cowboy', desc: 'Uses a tiny hoe.' },
                { id: 'turbo', name: 'Turbo Bunny', cost: 2000, production: 12, icon: 'fa-running', desc: 'Moves incredibly fast.' },
                { id: 'robot', name: 'Mecha Bunny', cost: 25000, production: 80, icon: 'fa-robot', desc: 'Efficient harvesting.' }
            ],
            burrows: [
                { id: 'hole', name: 'Small Burrow', cost: 1000, production: 5, icon: 'fa-campground', desc: 'Cozy underground home.' },
                { id: 'tunnel', name: 'Deep Tunnel', cost: 7500, production: 25, icon: 'fa-dungeon', desc: 'Miles of storage.' },
                { id: 'farm', name: 'Carrot Farm', cost: 40000, production: 140, icon: 'fa-warehouse', desc: 'Industrial scale.' },
                { id: 'greenhouse', name: 'Greenhouse', cost: 200000, production: 750, icon: 'fa-leaf', desc: 'Year-round growth.' }
            ],
            upgrades: [
                { id: 'u_tap1', name: 'Sharper Incisors', cost: 250, type: 'tap', val: 1, icon: 'fa-teeth', desc: '+1 Carrot per tap' },
                { id: 'u_tap2', name: 'Energized Paws', cost: 1000, type: 'tap', val: 3, icon: 'fa-hand-sparkles', desc: '+3 Carrots per tap' },
                { id: 'u_all1', name: 'Bunny Union', cost: 5000, type: 'global', val: 1.1, icon: 'fa-users', desc: 'Production +10%' },
                { id: 'u_click_crit', name: 'Mega Crunch', cost: 15000, type: 'crit', val: 0.05, icon: 'fa-star', desc: '5% Chance for x10 Tap' },
                { id: 'u_turbo', name: 'Headbands', cost: 50000, type: 'unit', target: 'turbo', val: 1.5, icon: 'fa-ribbon', desc: 'Turbo Bunnies +50%' }
            ]
        };

        // Love Achievements System
        const MILESTONES = [
            { threshold: 100, msg: "You got your first 100 Carrots! - Keep going baby :) ‚ù§Ô∏è", seen: false },
            { threshold: 500, msg: "500 Carrots! - You're so awesome bunny! ‚ù§Ô∏è", seen: false },
            { threshold: 1000, msg: "1,000 Carrots! - I love how driven you are sweetheart üåü", seen: false },
            { threshold: 5000, msg: "5,000 Carrots! - You're doing so good gorgeous! üíñ", seen: false },
            { threshold: 21000, msg: "21,000 for your 21st! - Happy Birthday! üéÇ", seen: false },
            { threshold: 50000, msg: "50k! - Keep on hopping mi conejita! üê∞", seen: false },
            { threshold: 100000, msg: "100k! - It's so sexy how good you are ü•¥", seen: false },
            { threshold: 500000, msg: "500k! - Okay no need to show off now üôÑ", seen: false },
            { threshold: 1000000, msg: "1M! - Now that's how I know you're my bunny üòâ", seen: false },
            { threshold: 10000000, msg: "10M CARROTS?! - How are you so good mama?! ü•¥", seen: false },
            { threshold: 100000000, msg: "100M CARROTS?! - Just sit on my face already ü§§", seen: false },
            { threshold: 1000000000, msg: "1 BILLION CARROTS! You've done it all you sexy little thing üòç", seen: false }
        ];

        /**
         * GAME ENGINE
         */
        const game = {
            state: {
                carrots: 0,
                totalCarrots: 0, // Lifetime for prestige
                prestigePoints: 0,
                clickCount: 0,
                startTime: Date.now(),
                items: {}, // key: id, value: count
                upgrades: [], // list of purchased upgrade IDs
                milestonesSeen: [] // IDs of milestones seen
            },
            
            modifiers: {
                globalProdMult: 1,
                tapValue: 1,
                critChance: 0,
                eventMult: 1
            },

            settings: {
                nightMode: false
            },

            timers: {
                lastTick: Date.now(),
                goldenBunny: null,
                nightMode: null,
                storm: null
            },

            // Initialization
            init() {
                this.load();
                this.initUI();
                this.gameLoop();
                this.setupEvents();
                
                // Show Intro Modal
                setTimeout(() => {
                    document.getElementById('intro-modal').style.display = 'flex';
                }, 500);

                // Auto-save
                setInterval(() => this.save(), 10000);
            },

            closeIntro() {
                document.getElementById('intro-modal').style.display = 'none';
                // Optional: Play a sound here if desired
            },

            // UI Setup
            initUI() {
                // Render Bunnies
                const bunnyContainer = document.getElementById('tab-bunnies');
                CONFIG.bunnies.forEach(item => {
                    bunnyContainer.innerHTML += this.createItemCard(item, 'bunny');
                    if(!this.state.items[item.id]) this.state.items[item.id] = 0;
                });

                // Render Burrows
                const burrowContainer = document.getElementById('tab-burrows');
                CONFIG.burrows.forEach(item => {
                    burrowContainer.innerHTML += this.createItemCard(item, 'burrow');
                    if(!this.state.items[item.id]) this.state.items[item.id] = 0;
                });

                // Render Upgrades
                this.renderUpgrades();

                // Listeners
                document.getElementById('giant-carrot').addEventListener('touchstart', (e) => {
                    e.preventDefault(); // Prevent zoom
                    // Handle multi-touch
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        this.handleTap(e.changedTouches[i].clientX, e.changedTouches[i].clientY);
                    }
                }, { passive: false });

                document.getElementById('giant-carrot').addEventListener('click', (e) => {
                    // Fallback for desktop testing
                    this.handleTap(e.clientX, e.clientY);
                });

                document.getElementById('golden-bunny').addEventListener('touchstart', (e) => {
                    e.preventDefault(); 
                    this.clickGoldenBunny();
                });
                document.getElementById('golden-bunny').addEventListener('click', () => this.clickGoldenBunny());
            },

            renderUpgrades() {
                const container = document.getElementById('tab-upgrades');
                container.innerHTML = '';
                CONFIG.upgrades.forEach(upg => {
                    if (this.state.upgrades.includes(upg.id)) return; // Already bought
                    container.innerHTML += `
                        <div class="bg-white dark:bg-[#354a3b] p-3 rounded-xl shadow-sm flex items-center justify-between border border-gray-100 dark:border-[#4a6352]" id="card-${upg.id}">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-[#e9f0ea] text-[#354a3b] flex items-center justify-center">
                                    <i class="fas ${upg.icon}"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-sm dark:text-white">${upg.name}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${upg.desc}</div>
                                </div>
                            </div>
                            <button onclick="game.buyUpgrade('${upg.id}')" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-sm btn-press min-w-[80px]">
                                ${this.formatNumber(upg.cost)} ü•ï
                            </button>
                        </div>
                    `;
                });
                if (container.innerHTML === '') {
                    container.innerHTML = '<div class="text-center text-gray-400 mt-10">All upgrades purchased!</div>';
                }
            },

            createItemCard(item, type) {
                return `
                    <div class="bg-white dark:bg-[#354a3b] p-3 rounded-xl shadow-sm flex items-center justify-between border border-gray-100 dark:border-[#4a6352] item-card" data-id="${item.id}">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-[#e9f0ea] dark:bg-[#4a6352] text-[#26352a] flex items-center justify-center text-xl relative">
                                <i class="fas ${item.icon}"></i>
                                <div class="absolute -top-2 -right-2 bg-gray-800 text-white text-[10px] rounded-full w-5 h-5 flex items-center justify-center font-bold count-badge" id="count-${item.id}">0</div>
                            </div>
                            <div>
                                <div class="font-bold text-sm dark:text-white">${item.name}</div>
                                <div class="text-xs text-green-600 font-mono">+${item.production} CPS</div>
                            </div>
                        </div>
                        <button onclick="game.buyItem('${item.id}', '${type}')" class="bg-orange-500 hover:bg-orange-600 disabled:bg-gray-300 dark:disabled:bg-[#4a6352] text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm btn-press min-w-[90px] transition-colors" id="btn-${item.id}">
                            ${this.formatNumber(item.cost)}
                        </button>
                    </div>
                `;
            },

            // Core Mechanics
            handleTap(x, y) {
                // Calculate value
                let val = (1 + (this.state.prestigePoints * 0.1)); // Base + Prestige
                
                // Add Tap Upgrades
                CONFIG.upgrades.forEach(u => {
                    if (this.state.upgrades.includes(u.id) && u.type === 'tap') val += u.val;
                });

                // Apply Event Multiplier
                val *= this.modifiers.eventMult;

                // Crit check
                let isCrit = false;
                let critChance = this.modifiers.critChance;
                if (Math.random() < critChance) {
                    val *= 10;
                    isCrit = true;
                }

                this.addCarrots(val);
                this.state.clickCount++;

                // LOVE CLICK MECHANIC
                // Every 50 clicks, show a heart and big message
                let isLoveClick = (this.state.clickCount > 0 && this.state.clickCount % 50 === 0);
                if (isLoveClick) {
                    this.spawnParticle(x, y, "‚ù§Ô∏è", true);
                    // Haptic
                    if (navigator.vibrate) navigator.vibrate([10, 50, 10]);
                } else {
                    // Visuals Normal
                    this.spawnParticle(x, y, `+${this.formatNumber(val)}`, isCrit);
                }
                
                this.animateCarrot();
                if (!isLoveClick && navigator.vibrate) navigator.vibrate(isCrit ? 50 : 5);
            },

            calculateCPS() {
                let cps = 0;
                
                // Bunnies
                CONFIG.bunnies.forEach(b => {
                    let count = this.state.items[b.id] || 0;
                    let prod = b.production;
                    
                    // Specific Upgrade logic
                    if (b.id === 'turbo' && this.state.upgrades.includes('u_turbo')) {
                        prod *= 1.5;
                    }
                    
                    cps += count * prod;
                });

                // Burrows
                CONFIG.burrows.forEach(b => {
                    let count = this.state.items[b.id] || 0;
                    cps += count * b.production;
                });

                // Global Multipliers
                let globalMult = 1 + (this.state.prestigePoints * 0.1); // +10% per prestige point
                if (this.state.upgrades.includes('u_all1')) globalMult *= 1.1;
                
                // Events
                globalMult *= this.modifiers.eventMult;

                return cps * globalMult;
            },

            addCarrots(amount) {
                this.state.carrots += amount;
                this.state.totalCarrots += amount;
                this.updateHeader();
                this.updateButtons();
                this.checkMilestones();
            },

            checkMilestones() {
                MILESTONES.forEach((m, index) => {
                    if (!this.state.milestonesSeen.includes(index) && this.state.totalCarrots >= m.threshold) {
                        // Trigger Milestone
                        this.state.milestonesSeen.push(index);
                        this.spawnMessage(m.msg);
                        // Confetti effect could go here too
                    }
                });
            },

            // Purchasing Logic
            buyItem(id, type) {
                const list = type === 'bunny' ? CONFIG.bunnies : CONFIG.burrows;
                const item = list.find(i => i.id === id);
                const currentCount = this.state.items[id];
                
                // Cost Formula: Base * 1.15^count
                const cost = Math.floor(item.cost * Math.pow(1.15, currentCount));

                if (this.state.carrots >= cost) {
                    this.state.carrots -= cost;
                    this.state.items[id]++;
                    
                    // Update UI
                    this.updateHeader();
                    this.updateButtons();
                    
                    if(navigator.vibrate) navigator.vibrate(10);
                }
            },

            buyUpgrade(id) {
                const upg = CONFIG.upgrades.find(u => u.id === id);
                if (this.state.carrots >= upg.cost) {
                    this.state.carrots -= upg.cost;
                    this.state.upgrades.push(id);
                    
                    // Apply instant effects
                    if (upg.type === 'crit') this.modifiers.critChance += upg.val;

                    this.renderUpgrades();
                    this.updateHeader();
                }
            },

            // Visual & Audio
            spawnParticle(x, y, text, isCrit) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.innerText = text;
                p.style.left = `${x}px`;
                p.style.top = `${y - 50}px`; // Offset slightly up
                p.style.color = isCrit ? '#ec4899' : '#ff8c42'; // Pink if crit/love
                if (isCrit) {
                    p.style.fontSize = '3rem';
                    p.style.textShadow = '0 0 15px pink';
                }
                
                document.getElementById('particle-container').appendChild(p);
                setTimeout(() => p.remove(), 1000);
            },

            animateCarrot() {
                const carrot = document.getElementById('giant-carrot');
                carrot.classList.remove('carrot-squish');
                void carrot.offsetWidth; // trigger reflow
                carrot.classList.add('carrot-squish');
            },

            // Game Loop
            gameLoop() {
                const now = Date.now();
                const dt = (now - this.timers.lastTick) / 1000;
                this.timers.lastTick = now;

                if (dt > 0) {
                    const cps = this.calculateCPS();
                    this.addCarrots(cps * dt);
                }

                requestAnimationFrame(() => this.gameLoop());
            },

            // Event System
            setupEvents() {
                // Kylie Bunny: Every 60-120 seconds
                setInterval(() => {
                    if (Math.random() > 0.5) this.spawnGoldenBunny();
                }, 45000);

                // Night Mode: Every 3 minutes
                setInterval(() => {
                    this.toggleNightMode();
                }, 180000);
                
                // Carrot Storm: Random chance
                setInterval(() => {
                    if (Math.random() > 0.8) this.triggerStorm();
                }, 120000);
            },

            spawnGoldenBunny() {
                const bunny = document.getElementById('golden-bunny');
                bunny.style.display = 'block';
                bunny.style.top = `${Math.random() * 40 + 10}%`; // Random height
                
                // Animate
                let pos = -10;
                const interval = setInterval(() => {
                    pos += 0.5;
                    bunny.style.left = `${pos}%`;
                    if (pos > 110) {
                        clearInterval(interval);
                        bunny.style.display = 'none';
                    }
                }, 16);
                
                // Store interval to clear if clicked
                bunny.dataset.intervalId = interval;
            },

            clickGoldenBunny() {
                const bunny = document.getElementById('golden-bunny');
                clearInterval(bunny.dataset.intervalId);
                bunny.style.display = 'none';
                
                // Reward: 5 minutes of CPS or big flat amount
                const reward = Math.max(100, this.calculateCPS() * 100);
                this.addCarrots(reward);
                
                this.spawnMessage("Found Kylie Bunny! üê∞ +" + this.formatNumber(reward));
                if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
            },

            triggerStorm() {
                this.modifiers.eventMult = 3;
                document.getElementById('storm-overlay').style.display = 'block';
                this.showBanner("BIRTHDAY SURPRISE! (x3)");
                
                setTimeout(() => {
                    this.modifiers.eventMult = 1;
                    document.getElementById('storm-overlay').style.display = 'none';
                    this.hideBanner();
                }, 15000); // 15 seconds
            },

            toggleNightMode() {
                this.settings.nightMode = !this.settings.nightMode;
                if (this.settings.nightMode) {
                    document.body.classList.add('night-mode');
                    this.spawnMessage("Night falls... bunnies get the zoomies at night (x3)");
                } else {
                    document.body.classList.remove('night-mode');
                }
            },

            // Prestige System
            prestige() {
                const pending = Math.floor(Math.sqrt(this.state.totalCarrots / 1000000));
                if (pending === 0 && this.state.prestigePoints === 0 && this.state.totalCarrots < 1000000) {
                    alert("Not enough total harvested carrots to ascend! (Need 1M+)");
                    return;
                }

                if (confirm(`Ascend? You will lose resources/buildings but gain ${pending} Spirit Points.`)) {
                    this.state.prestigePoints += pending;
                    // Reset Logic
                    this.state.carrots = 0;
                    this.state.totalCarrots = 0;
                    this.state.items = {};
                    this.state.upgrades = [];
                    this.state.milestonesSeen = []; // Reset milestones for replay value? Or keep them? Let's reset.
                    CONFIG.bunnies.forEach(b => this.state.items[b.id] = 0);
                    CONFIG.burrows.forEach(b => this.state.items[b.id] = 0);
                    
                    this.save();
                    location.reload();
                }
            },

            hardReset() {
                if(confirm("Are you sure? This deletes EVERYTHING.")) {
                    localStorage.removeItem('bunnyClickerSave');
                    location.reload();
                }
            },

            // Utilities
            updateHeader() {
                document.getElementById('carrot-display').innerText = this.formatNumber(Math.floor(this.state.carrots));
                document.getElementById('cps-display').innerText = this.formatNumber(this.calculateCPS().toFixed(1));
                
                // Calculate Pending Prestige
                const pending = Math.floor(Math.sqrt(this.state.totalCarrots / 1000000));
                document.getElementById('pending-bsp').innerText = pending;
                document.getElementById('current-bsp').innerText = this.state.prestigePoints;

                if (this.state.prestigePoints > 0) {
                    document.getElementById('prestige-status').classList.remove('hidden');
                    document.getElementById('spirit-bonus').innerText = (this.state.prestigePoints * 10) + "%";
                }
            },

            updateButtons() {
                // Update Bunnies
                CONFIG.bunnies.forEach(item => {
                    const currentCount = this.state.items[item.id];
                    const cost = Math.floor(item.cost * Math.pow(1.15, currentCount));
                    
                    document.getElementById(`count-${item.id}`).innerText = currentCount;
                    const btn = document.getElementById(`btn-${item.id}`);
                    btn.innerText = this.formatNumber(cost);
                    
                    if (this.state.carrots >= cost) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50');
                    } else {
                        btn.disabled = true;
                        btn.classList.add('opacity-50');
                    }
                });

                // Update Burrows
                CONFIG.burrows.forEach(item => {
                    const currentCount = this.state.items[item.id];
                    const cost = Math.floor(item.cost * Math.pow(1.15, currentCount));
                    
                    document.getElementById(`count-${item.id}`).innerText = currentCount;
                    const btn = document.getElementById(`btn-${item.id}`);
                    btn.innerText = this.formatNumber(cost);
                    
                    if (this.state.carrots >= cost) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50');
                    } else {
                        btn.disabled = true;
                        btn.classList.add('opacity-50');
                    }
                });
            },

            spawnMessage(msg) {
                const banner = document.getElementById('event-banner');
                banner.innerText = msg;
                banner.style.transform = 'translateY(0)';
                setTimeout(() => banner.style.transform = 'translateY(-120px)', 4000);
            },

            showBanner(msg) {
                const banner = document.getElementById('event-banner');
                banner.innerText = msg;
                banner.style.transform = 'translateY(0)';
            },

            hideBanner() {
                document.getElementById('event-banner').style.transform = 'translateY(-120px)';
            },

            formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            },

            save() {
                localStorage.setItem('bunnyClickerSave', JSON.stringify(this.state));
            },

            load() {
                const saved = localStorage.getItem('bunnyClickerSave');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Merge to ensure new fields exist if updated
                    this.state = { ...this.state, ...parsed };
                    
                    // Ensure milestones array exists
                    if (!this.state.milestonesSeen) this.state.milestonesSeen = [];
                    
                    // Re-init empty items if new ones added to CONFIG
                    CONFIG.bunnies.forEach(b => { if(this.state.items[b.id] === undefined) this.state.items[b.id] = 0; });
                    CONFIG.burrows.forEach(b => { if(this.state.items[b.id] === undefined) this.state.items[b.id] = 0; });
                }
            }
        };

        // Tab Switch Logic
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('button[id^="tab-btn-"]').forEach(el => {
                el.classList.remove('text-orange-500', 'border-b-2', 'border-orange-500');
                el.classList.add('text-gray-400');
            });

            // Show target
            document.getElementById(`tab-${tabId}`).classList.add('active');
            const btn = document.getElementById(`tab-btn-${tabId}`);
            btn.classList.remove('text-gray-400');
            btn.classList.add('text-orange-500', 'border-b-2', 'border-orange-500');
        }

        // Start Game
        window.onload = () => game.init();
        window.onbeforeunload = () => game.save();

    </script>
</body>
</html>